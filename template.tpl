___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Admitad (Mitgo)",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Admitad (Mitgo) server to server conversion tracking",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "type",
    "displayName": "Event Type",
    "radioItems": [
      {
        "value": "page_view",
        "displayValue": "PageView"
      },
      {
        "value": "conversion",
        "displayValue": "Conversion"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "page_view",
    "help": "\u003cb\u003ePageView\u003c/b\u003e - stores the {admitad_uid} URL parameter value inside the _\u003ci\u003eaid\u003c/i\u003e cookie; and the traffic source value (e.g. {utm_source} URL parameter value) inside the \u003ci\u003e_admitad_source\u003c/i\u003e cookie.\u003cbr\u003e\u003cbr\u003e\n\u003cb\u003eConversion\u003c/b\u003e - Send request with data about the conversion to Admitad. The conversion  event will only be sent when the last paid traffic source is Admitad."
  },
  {
    "type": "GROUP",
    "name": "pageViewGroup",
    "displayName": "",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "clickIdParameterName",
        "displayName": "Name of the URL parameter for the Click ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "admitad_uid",
        "help": "By default, it\u0027s the \u003ci\u003eadmitad_uid\u003c/i\u003e URL parameter. In most cases you won\u0027t need to change it. Only change it if you do a custom implementation.",
        "valueHint": "admitad_uid"
      },
      {
        "type": "TEXT",
        "name": "sourceChannelParameterName",
        "displayName": "Last Paid Click URL Parameter",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "utm_source",
        "help": "Specify a comma-separated list of URL parameters used to identify paid traffic sources.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eutm_source\u003c/i\u003e",
        "valueHint": "utm_source"
      },
      {
        "type": "TEXT",
        "name": "additionalSourceChannelParametersName",
        "displayName": "Additional Last Paid Click URL Parameters",
        "simpleValueType": true,
        "help": "Specify a comma-separated list of additional URL parameters that may indicate a paid source.\n\u003cbr/\u003e\u003cbr/\u003e\nUse this field when the primary \u003cb\u003eLast Paid Click URL Parameter\u003c/b\u003e might not be present in the URL, or when dealing with unique tracking parameters from various ad platforms.\n\u003cbr/\u003e\u003cbr/\u003e\nThis field has lower precedence than the \u003cb\u003eLast Paid Click URL Parameter\u003c/b\u003e and acts as a fallback.\n\u003cbr/\u003e\u003cbr/\u003e\nCommon examples include:\n\u003cul\u003e \u003cli\u003e\u003cb\u003eMeta\u003c/b\u003e: fbclid\u003c/li\u003e \u003cli\u003e\u003cb\u003eGoogle\u003c/b\u003e: gclid, dclid, gbraid, wbraid\u003c/li\u003e \u003cli\u003e\u003cb\u003eTikTok\u003c/b\u003e: ttclid\u003c/li\u003e \u003cli\u003e\u003cb\u003eX (Twitter)\u003c/b\u003e: twclid\u003c/li\u003e \u003cli\u003e\u003cb\u003eBing\u003c/b\u003e: msclkid\u003c/li\u003e \u003cli\u003e\u003cb\u003eSnapchat\u003c/b\u003e: scclid\u003c/li\u003e \u003cli\u003e\u003cb\u003ePinterest\u003c/b\u003e: epik\u003c/li\u003e \u003cli\u003e\u003cb\u003eAwin\u003c/b\u003e: awc\u003c/li\u003e \u003c/ul\u003e",
        "valueHint": "gclid,wbraid,gbraid,fbclid,ttclid"
      },
      {
        "type": "GROUP",
        "name": "cookieSettingsGroup",
        "displayName": "Cookie Settings",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "cookieExpiration",
            "displayName": "Cookie Expiration",
            "simpleValueType": true,
            "help": "The number of days Admitad cookies (Click ID and source channel cookie) will live. \n\u003cbr/\u003e\nSet this value according to the agreement.",
            "valueValidators": [],
            "valueUnit": "days",
            "defaultValue": 395,
            "valueHint": "395"
          },
          {
            "type": "TEXT",
            "name": "cookieDomain",
            "displayName": "Cookie Domain",
            "simpleValueType": true,
            "help": "Enable this option to override the cookie domain.\n\u003cbr\u003e\nEnter your website\u0027s top-level domain as a fixed value (e.g., example.com).\n\u003cbr\u003e\nIf left unchecked, the top-level domain will be automatically determined using the following priority:\n\u003cul\u003e\n\u003cli\u003eTop-level domain of the \u003ci\u003eForwarded\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eTop-level domain of the \u003ci\u003eX-Forwarded-Host\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eTop-level domain of the \u003ci\u003eHost\u003c/i\u003e header.\u003c/li\u003e\n\u003c/ul\u003e",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "auto",
            "valueHint": "example.com"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "page_view",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversionGroup",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "admitadSourceChannelParameterValue",
        "displayName": "Admitad Traffic Source Identifier",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "admitad",
        "help": "Specify the expected \u003cb\u003evalue\u003c/b\u003e for the Last Paid Click URL Parameter that identifies Admitad traffic (e.g., \u003ci\u003eutm_source\u003dadmitad\u003c/i\u003e). \n\u003cbr/\u003e\nThis value will be compared with the one stored in the \u003ci\u003e_admitad_source\u003c/i\u003e cookie. The conversion event will \u003cb\u003eonly\u003c/b\u003e be sent if both values match.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault: \u003ci\u003eadmitad\u003c/i\u003e"
      },
      {
        "type": "TEXT",
        "name": "campaignCode",
        "displayName": "Campaign Code",
        "simpleValueType": true,
        "help": "A variable which is the target action code from your program settings. \u003ca target\u003d\"_blank\" href\u003d\"https://support.mitgo.com/knowledge-base/article/integration-via-postback-request_2#action-code-parameter\"\u003eHow to find an action code.\u003c/a\u003e",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "postbackKey",
        "displayName": "Postback Key",
        "simpleValueType": true,
        "help": "A constant whose value is defined in the postback request."
      },
      {
        "type": "TEXT",
        "name": "actionCode",
        "displayName": "Action Code",
        "simpleValueType": true,
        "help": "A variable which is the target action code from your program settings. \u003ca target\u003d\"_blank\" href\u003d\"https://support.mitgo.com/knowledge-base/article/integration-via-postback-request_2#action-code-parameter\"\u003eHow to find an action code.\u003c/a\u003e",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "tariffCode",
        "displayName": "Tariff Code",
        "simpleValueType": true,
        "help": "A variable which is the rate code from your program settings. \u003ca target\u003d\"_blank\" href\u003d\"https://support.mitgo.com/knowledge-base/article/integration-via-postback-request_2#tariff-code-parameter\"\u003eHow to find an tariff code.\u003c/a\u003e",
        "defaultValue": 1
      },
      {
        "type": "TEXT",
        "name": "paymentType",
        "displayName": "Payment Type",
        "simpleValueType": true,
        "help": "A constant with the value \"sale\".",
        "defaultValue": "sale"
      },
      {
        "type": "GROUP",
        "name": "overrideParamsGroup",
        "displayName": "Parameters Override (Optional)",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "TEXT",
            "name": "orderId",
            "displayName": "Order ID",
            "simpleValueType": true,
            "help": "Unique alphanumeric Order ID for the transaction or event"
          },
          {
            "type": "TEXT",
            "name": "currencyCode",
            "displayName": "Currency Code",
            "simpleValueType": true,
            "help": "Defined in ISO 4217. Letters only."
          },
          {
            "type": "TEXT",
            "name": "price",
            "displayName": "Price",
            "simpleValueType": true,
            "help": "Use a period as a divider."
          },
          {
            "type": "TEXT",
            "name": "clientId",
            "displayName": "Client ID",
            "simpleValueType": true,
            "help": "Your internal client ID"
          },
          {
            "type": "TEXT",
            "name": "quantity",
            "displayName": "Quantity",
            "simpleValueType": true
          },
          {
            "type": "TEXT",
            "name": "positionId",
            "displayName": "Position Id",
            "simpleValueType": true,
            "help": "A variable varying from 1 to N, where N \u003d position_count."
          },
          {
            "type": "TEXT",
            "name": "positionCount",
            "displayName": "Position Count",
            "simpleValueType": true,
            "help": "A variable with the value N that depends on what\u0027s in the user\u0027s cart."
          },
          {
            "type": "TEXT",
            "name": "productId",
            "displayName": "Product ID",
            "simpleValueType": true,
            "help": "Product ID that must match the ID from the product feed if you use this tool. \u003ca target\u003d\"_blank\" href\u003d\"https://support.admitad.com/hc/en-us/articles/4405920538897\"\u003e Learn more about the product feed.\u003c/a\u003e"
          },
          {
            "type": "TEXT",
            "name": "countryCode",
            "displayName": "Country Code",
            "simpleValueType": true,
            "help": "Defined in ISO 3166. Letters only."
          },
          {
            "type": "TEXT",
            "name": "city",
            "displayName": "City",
            "simpleValueType": true,
            "help": "Only use this parameter if you have set up geotargeting."
          },
          {
            "type": "TEXT",
            "name": "promocode",
            "displayName": "Promocode",
            "simpleValueType": true,
            "help": "Use this parameter if you need to set up passing personal promo codes."
          },
          {
            "type": "SELECT",
            "name": "items",
            "displayName": "Products (Items)",
            "macrosInSelect": true,
            "selectItems": [],
            "simpleValueType": true,
            "notSetText": "(not set)"
          }
        ],
        "help": "By default, all parameters will be parsed from eventData"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettingsGroup",
    "displayName": "Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr\u003e\u003cbr\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getCookieValues = require('getCookieValues');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeString = require('makeString');
const parseUrl = require('parseUrl');
const sendHttpRequest = require('sendHttpRequest');
const setCookie = require('setCookie');

/**********************************************************************************************/

const traceId = getRequestHeader('trace-id');

const eventData = getAllEventData();

if (!isConsentGivenOrNotRequired()) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const actionHandlers = {
  page_view: trackPageView,
  conversion: trackConversion
};

const handler = actionHandlers[data.type];
if (handler) {
  handler();
} else {
  return data.gtmOnFailure();
}

return data.gtmOnSuccess();

/**********************************************************************************************/
// Vendor related functions

function trackPageView() {
  if (!url) return;

  const cookieOptions = {
    domain: data.cookieDomain || 'auto',
    path: '/',
    secure: true,
    httpOnly: false,
    'max-age': 60 * 60 * 24 * (makeInteger(data.cookieExpiration) || 395)
  };

  const urlSearchParams = parseUrl(url).searchParams;

  const clickIdValue = urlSearchParams[data.clickIdParameterName || 'admitad_uid'];
  if (clickIdValue) {
    setCookie('_aid', clickIdValue, cookieOptions, false);
  }

  const sourceChannelParametersName = (data.sourceChannelParameterName || 'utm_source')
    .concat(',', data.additionalSourceChannelParametersName || '')
    .split(',')
    .filter((p) => !!p)
    .map((p) => p.trim());
  sourceChannelParametersName.some((p) => {
    const sourceChannelParameterValue = urlSearchParams[p];
    if (sourceChannelParameterValue) {
      setCookie('_admitad_source', sourceChannelParameterValue, cookieOptions, false);
      return true;
    }
    return false;
  });
}

function trackConversion() {
  const admitadSourceChannelParameterValue = (data.admitadSourceChannelParameterValue || 'admitad').toLowerCase();
  const lastSourceChannel = (getCookieValues('_admitad_source')[0] || '').toLowerCase();

  if (lastSourceChannel !== admitadSourceChannelParameterValue) return;

  const requestUrls = getRequestUrls();

  (requestUrls || []).forEach((requestUrl) => {
    if (!requestUrl) return;
    sendRequest(requestUrl);
  });
}

function sendRequest(requestUrl) {
  log({
    Name: 'Admitad',
    Type: 'Request',
    TraceId: traceId,
    EventName: 'Conversion',
    RequestMethod: 'GET',
    RequestUrl: requestUrl
  });

  sendHttpRequest(
    requestUrl,
    (statusCode, headers, body) => {
      log({
        Name: 'Admitad',
        Type: 'Response',
        TraceId: traceId,
        EventName: 'Conversion',
        ResponseStatusCode: statusCode,
        ResponseHeaders: headers,
        ResponseBody: body
      });
      // https://support.mitgo.com/knowledge-base/article/integration-via-postback-request_2#how-to-set-postback-request
      // "The Admitad server doesn't have any special response to postback requests.
      // You will always see the status "HTTP 200 OK".
    },
    { method: 'GET' }
  );
}

function getRequestUrls() {
  let requestUrl = 'https://ad.admitad.com/r?postback=1';

  requestUrl = requestUrl + '&campaign_code=' + enc(data.campaignCode);
  requestUrl = requestUrl + '&postback_key=' + enc(data.postbackKey);
  requestUrl = requestUrl + '&action_code=' + enc(data.actionCode);
  requestUrl = requestUrl + '&tariff_code=' + enc(data.tariffCode);
  requestUrl = requestUrl + '&payment_type=' + enc(data.paymentType);

  const orderId = data.orderId || eventData.orderId || eventData.order_id || eventData.transaction_id;
  if (orderId) {
    requestUrl = requestUrl + '&order_id=' + enc(orderId);
  }

  const price = data.price || eventData.amount || eventData.value || eventData.price;
  if (price) {
    requestUrl = requestUrl + '&price=' + enc(price);
  }

  const clientId = data.clientId || eventData.external_id;
  if (clientId) {
    requestUrl = requestUrl + '&client_id=' + enc(clientId);
  }

  const currency = data.currencyCode || eventData.currencyCode || eventData.currency;
  if (currency) {
    requestUrl = requestUrl + '&currency_code=' + enc(currency);
  }

  const city = data.city || eventData.city || eventData.city;
  if (city) {
    requestUrl = requestUrl + '&city=' + enc(city);
  }

  const coupon = data.promocode || eventData.promocode || eventData.coupon;
  if (coupon) {
    requestUrl = requestUrl + '&promocode=' + enc(coupon);
  }

  const cookie = getCookieValues('_aid')[0] || '';
  if (cookie) {
    requestUrl = requestUrl + '&uid=' + enc(cookie);
  }

  if (data.quantity || data.positionId || data.positionCount || data.productId) {
    const quantity = data.quantity || eventData.quantity;
    if (quantity) {
      requestUrl = requestUrl + '&quantity=' + enc(quantity);
    }

    if (data.positionId) {
      requestUrl = requestUrl + '&position_id=' + enc(data.positionId);
    }

    if (data.positionCount) {
      requestUrl = requestUrl + '&position_count=' + enc(data.positionCount);
    }

    const productId = data.productId || eventData.productId;
    if (productId) {
      requestUrl = requestUrl + '&product_id=' + enc(productId);
    }

    return [requestUrl];
  }

  const items = data.items || eventData.items || [];

  if (!items || !items.length) {
    return [requestUrl];
  }

  let requestUrls = [];

  for (let i = 0; i < items.length; i++) {
    let item = items[i];
    let itemUrl = requestUrl + '&quantity=' + enc(item.quantity || item.item_quantity);

    if (item.positionId) {
      itemUrl = itemUrl + '&position_id=' + enc(i + 1);
    }

    if (item.positionCount) {
      itemUrl = itemUrl + '&position_count=' + enc(items.length);
    }

    if (item.productId) {
      itemUrl = itemUrl + '&product_id=' + enc(item.productId || item.product_id || item.item_id);
    }

    if (sameUrlExists(requestUrls, itemUrl)) {
      continue;
    }

    requestUrls.push(itemUrl);
  }

  return requestUrls;
}

/**********************************************************************************************/
// Helpers

function sameUrlExists(urls, url) {
  for (let i = 0; i < urls.length; i++) {
    if (urls[i] === url) return true;
  }
  return false;
}

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function isConsentGivenOrNotRequired() {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  // Key mappings for each log destination
  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;
    // Map keys based on the log destination
    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key; // Fallback to original key if no mapping exists
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  // timestamp is required.
  dataToLog.timestamp = getTimestampMillis();

  // Columns with type JSON need to be stringified.
  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    // GTM Sandboxed JSON.parse returns undefined for malformed JSON but throws post-execution, causing execution failure.
    // If fixed, could use: dataToLog[p] = JSON.stringify(JSON.parse(dataToLog[p]) || dataToLog[p]);
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  // assertApi doesn't work for 'BigQuery.insert()'. It's needed to convert BigQuery into a function when testing.
  // Ref: https://gtm-gear.com/posts/gtm-templates-testing/
  const bigquery = getType(BigQuery) === 'function' ? BigQuery() /* Only during Unit Tests */ : BigQuery;
  bigquery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(containerVersion && (containerVersion.debugMode || containerVersion.previewMode));

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "_aid"
              },
              {
                "type": 1,
                "string": "_admitad_source"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_aid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_admitad_source"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ad.admitad.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: PageView - Cookies are NOT set if URL doesn't contain the Click ID and Traffic
    Source parameters
  code: |
    setMockDataForPageview();

    mock('getAllEventData', {
      page_location: 'https://example.com/'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasNotCalled();
- name: PageView - Cookies are NOT set if URL contains the Traffic Source parameters,
    but it doesn't match the ones listed
  code: |
    setMockDataForPageview();

    mock('getAllEventData', {
      page_location: 'https://example.com/?source=test&admitadid=test'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('setCookie').wasNotCalled();
- name: PageView - Click ID cookie is set if URL contains it
  code: "const expectedCookieDomain = 'example.com';\nconst expectedCookieExpirationInDays\
    \ = 90;\nsetMockDataForPageview({\n  cookieDomain: expectedCookieDomain,\n  cookieExpiration:\
    \ expectedCookieExpirationInDays \n});\n\nconst expectedClickId = 'expectedClickId';\n\
    mock('getAllEventData', {\n  page_location: 'https://example.com/?utm_source=test&admitad_uid='\
    \ + expectedClickId\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();\nassertApi('setCookie').wasCalledWith('_aid',\
    \ expectedClickId, {\n  domain: expectedCookieDomain,\n  path: '/',\n  secure:\
    \ true,\n  httpOnly: false,\n  'max-age': 60 * 60 * 24 * expectedCookieExpirationInDays\n\
    }, false);\n"
- name: PageView - Traffic Source cookie is set if URL contains it
  code: "const expectedCookieDomain = 'example.com';\nconst expectedCookieExpirationInDays\
    \ = 90;\nsetMockDataForPageview({\n  cookieDomain: expectedCookieDomain,\n  cookieExpiration:\
    \ expectedCookieExpirationInDays \n});\n\nconst expectedTrafficSource = 'expectedTrafficSource';\n\
    mock('getAllEventData', {\n  page_location: 'https://example.com/?utm_source='\
    \ + expectedTrafficSource + '&admitad_uid=test'\n});\n\nrunCode(mockData);\n\n\
    assertApi('gtmOnSuccess').wasCalled();\nassertApi('gtmOnFailure').wasNotCalled();\n\
    assertApi('setCookie').wasCalledWith('_admitad_source', expectedTrafficSource,\
    \ {\n  domain: expectedCookieDomain,\n  path: '/',\n  secure: true,\n  httpOnly:\
    \ false,\n  'max-age': 60 * 60 * 24 * expectedCookieExpirationInDays\n}, false);\n"
- name: Conversion - Request is NOT sent if the Traffic Source cookie is not from
    Admitad
  code: |
    setMockDataForConversion();
    const expectedAdmitadSourceCookie = 'google';
    setAdmitadSourceCookie(expectedAdmitadSourceCookie);

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('sendHttpRequest').wasNotCalled();
- name: Conversion - Request is sent if the Traffic Source cookie is from Admitad
    - Without items
  code: "setMockDataForConversion({\n  orderId: 'expectedOrderId',\n  price: '123.45',\n\
    \  clientId: 'expectedClientId',\n  currencyCode: 'expectedCurrencyCode',\n  city:\
    \ 'expectedCity',\n  promocode: 'expectedPromoCode',\n  quantity: 'expectedQuantity',\n\
    \  positionId: 'expectedPositionId',\n  positionCount: 'expectedPositionCount',\n\
    \  productId: 'expectedProductId'\n});\n\nconst expectedAdmitadSourceCookie =\
    \ 'admitad';\nsetAdmitadSourceCookie(expectedAdmitadSourceCookie);\n\nconst expectedRequestBaseUrl\
    \ = 'https://ad.admitad.com/r';\nconst expectedRequestOptions = { method: 'GET'\
    \ };\nconst expectedQueryParameters = {\n  postback: '1',\n  campaign_code: expectedConversionData.campaignCode,\n\
    \  postback_key: expectedConversionData.postbackKey,\n  action_code: expectedConversionData.actionCode,\n\
    \  tariff_code: expectedConversionData.tariffCode,\n  payment_type: expectedConversionData.paymentType,\n\
    \  order_id: expectedConversionData.orderId,\n  price: expectedConversionData.price,\n\
    \  client_id: expectedConversionData.clientId,\n  currency_code: expectedConversionData.currencyCode,\n\
    \  city: expectedConversionData.city,\n  promocode: expectedConversionData.promocode,\n\
    \  uid: expectedAdmitadSourceCookie,\n  quantity: expectedConversionData.quantity,\n\
    \  position_id: expectedConversionData.positionId,\n  position_count: expectedConversionData.positionCount,\n\
    \  product_id: expectedConversionData.productId\n};\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions) => {\n  const parsedRequestUrl = parseUrl(requestUrl);\n\
    \  assertThat(parsedRequestUrl.origin + parsedRequestUrl.pathname).isEqualTo(expectedRequestBaseUrl);\n\
    \  assertThat(parsedRequestUrl.searchParams).isEqualTo(expectedQueryParameters);\n\
    \  assertThat(callback).isFunction();\n  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n\
    \  \n  callback(200);\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: Conversion - Request is sent if the Traffic Source cookie is from Admitad
    - With items
  code: "setMockDataForConversion({\n  orderId: 'expectedOrderId',\n  price: '123.45',\n\
    \  clientId: 'expectedClientId',\n  currencyCode: 'expectedCurrencyCode',\n  city:\
    \ 'expectedCity',\n  promocode: 'expectedPromoCode',\n  items: [\n    { quantity:\
    \ '1', positionId: '1', positionCount: 'foobar', productId: '1' },\n    { quantity:\
    \ '2', positionId: '2', positionCount: 'foobar', productId: '2' },\n  ]\n});\n\
    \nconst expectedAdmitadSourceCookie = 'admitad';\nsetAdmitadSourceCookie(expectedAdmitadSourceCookie);\n\
    \nconst expectedRequestBaseUrl = 'https://ad.admitad.com/r';\nconst expectedRequestOptions\
    \ = { method: 'GET' };\nconst expectedQueryParametersList = expectedConversionData.items.map((item,\
    \ index) => {\n  return {\n    postback: '1',\n    campaign_code: expectedConversionData.campaignCode,\n\
    \    postback_key: expectedConversionData.postbackKey,\n    action_code: expectedConversionData.actionCode,\n\
    \    tariff_code: expectedConversionData.tariffCode,\n    payment_type: expectedConversionData.paymentType,\n\
    \    order_id: expectedConversionData.orderId,\n    price: expectedConversionData.price,\n\
    \    client_id: expectedConversionData.clientId,\n    currency_code: expectedConversionData.currencyCode,\n\
    \    city: expectedConversionData.city,\n    promocode: expectedConversionData.promocode,\n\
    \    uid: expectedAdmitadSourceCookie,\n    quantity: item.quantity,\n    position_id:\
    \ (index + 1) + '',\n    position_count: (expectedConversionData.items.length)\
    \ + '',\n    product_id: item.productId\n  };\n});\n\nlet expectedSendHttpRequestExecutions\
    \ = expectedQueryParametersList.length;\nmock('sendHttpRequest', (requestUrl,\
    \ callback, requestOptions) => {\n  const parsedRequestUrl = parseUrl(requestUrl);\n\
    \  \n  assertThat(parsedRequestUrl.origin + parsedRequestUrl.pathname).isEqualTo(expectedRequestBaseUrl);\n\
    \  assertThat(parsedRequestUrl.searchParams).isEqualTo(expectedQueryParametersList[expectedQueryParametersList.length\
    \ - expectedSendHttpRequestExecutions]);\n  assertThat(callback).isFunction();\n\
    \  assertThat(requestOptions).isEqualTo(expectedRequestOptions);\n  \n  callback(200);\n\
    \  \n  expectedSendHttpRequestExecutions--;\n});\n\nrunCode(mockData);\n\nassertApi('gtmOnSuccess').wasCalled();\n\
    assertApi('gtmOnFailure').wasNotCalled();"
- name: Should log to console, if the 'Always log to console' option is selected
  code: "mockData = setMockDataForConversion();\nmockData.logType = 'always';\nsetAdmitadSourceCookie('admitad');\n\
    \nconst expectedDebugMode = true;\nmock('getContainerVersion', () => {\n  return\
    \ {\n    debugMode: expectedDebugMode\n  };\n}); \n\nmock('logToConsole', (logData)\
    \ => {\n  const parsedLogData = JSON.parse(logData);\n  requiredConsoleKeys.forEach(p\
    \ => assertThat(parsedLogData[p]).isDefined());\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions) => {\n  callback(200);\n});\n\nrunCode(mockData);\n\
    \nassertApi('logToConsole').wasCalled();\n"
- name: Should log to console, if the 'Log during debug and preview' option is selected
    AND is on preview mode
  code: |
    mockData = setMockDataForConversion();
    mockData.logType = 'debug';
    setAdmitadSourceCookie('admitad');

    const expectedDebugMode = true;
    mock('getContainerVersion', () => {
      return {
        debugMode: expectedDebugMode
      };
    });

    mock('logToConsole', (logData) => {
      const parsedLogData = JSON.parse(logData);
      requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());
    });

    mock('sendHttpRequest', (requestUrl, callback, requestOptions) => {
      callback(200);
    });

    runCode(mockData);

    assertApi('logToConsole').wasCalled();
- name: Should NOT log to console, if the 'Log during debug and preview' option is
    selected AND is NOT on preview mode
  code: "mockData = setMockDataForConversion();\nmockData.logType = 'debug';\nsetAdmitadSourceCookie('admitad');\n\
    \nconst expectedDebugMode = false;\nmock('getContainerVersion', () => {\n  return\
    \ {\n    debugMode: expectedDebugMode\n  };\n}); \n\nmock('sendHttpRequest', (requestUrl,\
    \ callback, requestOptions) => {\n  callback(200);\n});\n\nrunCode(mockData);\n\
    \nassertApi('logToConsole').wasNotCalled();\n"
- name: Should NOT log to console, if the 'Do not log' option is selected
  code: |
    mockData = setMockDataForConversion();
    mockData.logType = 'no';
    setAdmitadSourceCookie('admitad');

    mock('sendHttpRequest', (requestUrl, callback, requestOptions) => {
      callback(200);
    });

    runCode(mockData);

    assertApi('logToConsole').wasNotCalled();
- name: Should log to BQ, if the 'Log to BigQuery' option is selected
  code: "mockData = setMockDataForConversion();\nmockData.bigQueryLogType = 'always';\n\
    setAdmitadSourceCookie('admitad');\n\n// assertApi doesn't work for 'BigQuery.insert()'.\n\
    // Ref: https://gtm-gear.com/posts/gtm-templates-testing/\nmock('BigQuery', ()\
    \ => {\n  return { \n    insert: (connectionInfo, rows, options) => { \n     \
    \ assertThat(connectionInfo).isDefined();\n      assertThat(rows).isArray();\n\
    \      assertThat(rows).hasLength(1);\n      requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \      assertThat(options).isEqualTo(expectedBqOptions);\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions) => {\n  callback(200);\n});\n\nrunCode(mockData);"
- name: Should NOT log to BQ, if the 'Do not log to BigQuery' option is selected
  code: "mockData = setMockDataForConversion();\nmockData.bigQueryLogType = 'no';\n\
    setAdmitadSourceCookie('admitad');\n\n// assertApi doesn't work for 'BigQuery.insert()'.\n\
    // Ref: https://gtm-gear.com/posts/gtm-templates-testing/\nmock('BigQuery', ()\
    \ => {\n  return { \n    insert: (connectionInfo, rows, options) => { \n     \
    \ fail('BigQuery.insert should not have been called.');\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve();\n      });\n    }\n  };\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, callback, requestOptions) => {\n  callback(200);\n});\n\nrunCode(mockData);"
setup: "const JSON = require('JSON');\nconst Promise = require('Promise');\nconst\
  \ parseUrl = require('parseUrl');\n\nfunction mergeObj(target, source) {\n  for\
  \ (const key in source) {\n    if (source.hasOwnProperty(key)) target[key] = source[key];\n\
  \  }\n  return target;\n}\n\nconst expectedBigQuerySettings = {\n  logBigQueryProjectId:\
  \ 'logBigQueryProjectId',\n  logBigQueryDatasetId: 'logBigQueryDatasetId',\n  logBigQueryTableId:\
  \ 'logBigQueryTableId'\n};\nconst requiredConsoleKeys = ['Type', 'TraceId', 'Name'];\n\
  const requiredBqKeys = ['timestamp', 'type', 'trace_id', 'tag_name'];\nconst expectedBqOptions\
  \ = { ignoreUnknownValues: true };\n\nlet mockData = {\n  logBigQueryProjectId:\
  \ expectedBigQuerySettings.logBigQueryProjectId,\n  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n\
  \  logBigQueryTableId: expectedBigQuerySettings.logBigQueryTableId\n};\n\nconst\
  \ setAdmitadSourceCookie = (cookieValue) => {\n  mock('getCookieValues', () => {\
  \ \n    if ('_admitad_source') return [cookieValue];\n  });\n};\n\nconst expectedPageViewData\
  \ = {\n  clickIdParameterName: 'admitad_uid',\n  sourceChannelParameterName: 'utm_source',\n\
  \  additionalSourceChannelParametersName: 'gclid,fbclid',\n  admitadSourceChannelParameterValue:\
  \ 'admitad',\n  cookieExpiration: 90,\n  cookieDomain: 'expectedPaymentType'\n};\n\
  const setMockDataForPageview = (objToBeMerged) => {\n  mockData.type = 'page_view';\n\
  \  mockData.clickIdParameterName = expectedPageViewData.clickIdParameterName;\n\
  \  mockData.sourceChannelParameterName = expectedPageViewData.sourceChannelParameterName;\n\
  \  mockData.additionalSourceChannelParametersName = expectedPageViewData.additionalSourceChannelParametersName;\n\
  \  mockData.admitadSourceChannelParameterValue = expectedPageViewData.admitadSourceChannelParameterValue;\n\
  \  mockData.cookieExpiration = expectedPageViewData.cookieExpiration;\n  mockData.cookieDomain\
  \ = expectedPageViewData.cookieDomain;\n  mergeObj(expectedPageViewData, objToBeMerged);\n\
  \  return mergeObj(mockData, objToBeMerged);\n};\n\nconst expectedConversionData\
  \ = {\n  campaignCode: 'expectedCampaignCode',\n  postbackKey: 'expectedPostbackKey',\n\
  \  actionCode: 'expectedActionCode',\n  tariffCode: 'expectedTariffCode',\n  paymentType:\
  \ 'sale',\n};\nconst setMockDataForConversion = (objToBeMerged) => {\n  mockData.type\
  \ = 'conversion';\n  mockData.campaignCode = expectedConversionData.campaignCode;\n\
  \  mockData.postbackKey = expectedConversionData.postbackKey;\n  mockData.actionCode\
  \ = expectedConversionData.actionCode;\n  mockData.tariffCode = expectedConversionData.tariffCode;\n\
  \  mockData.paymentType = expectedConversionData.paymentType;\n  mergeObj(expectedConversionData,\
  \ objToBeMerged);\n  return mergeObj(mockData, objToBeMerged);\n};\n\n"


___NOTES___

Created on 12/27/2024, 3:32:15 PM

